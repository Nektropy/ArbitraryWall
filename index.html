<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»»æ„å¢™ Â· ä¸­å¿ƒç¼©æ”¾ Â· å³ä¸‹æ»‘å—</title>
    <!-- ä½¿ç”¨ marked è§£æ Markdown (è½»é‡, å®‰å…¨) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­ */
            margin: 0;
            padding: 0;
        }
        body {
            background: #2d241e;
            font-family: 'Segoe UI', 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: pan-x pan-y; /* ä¿ç•™åŒæŒ‡æ‰‹åŠ¿ä½†ä¸å½±å“æ»‘å— */
        }

        /* å…¨å±æ»šåŠ¨å®¹å™¨ */
        .wall-wrapper {
            width: 100vw;
            height: 100vh;
            overflow: auto;
            position: relative;
            /* è“å¤©èƒŒæ™¯ï¼Œç¼©å°æ—¶æ˜¾ç¤ºç¾è§‚çš„å¤–ç•Œ */
            background: linear-gradient(to bottom, #87ceeb, #b0e0e6);
            -webkit-overflow-scrolling: touch; /* æµç•…æ»šåŠ¨ */
            cursor: grab;
        }
        .wall-wrapper:active {
            cursor: grabbing;
        }

        /* å·¨å¢™ â€” èƒŒæ™¯å›¾ç‰‡é“¾æ¥åœ¨æ­¤ä¿®æ”¹ */
        .wall {
            position: relative;
            width: 10000px;
            height: 10000px;
            /* ===== èƒŒæ™¯å›¾ç‰‡é“¾æ¥ ===== */
            background-image: url('https://www.transparenttextures.com/patterns/old-wall.png');  /* é»˜è®¤ç –çº¹å›¾ç‰‡ */
            background-color: #b08a67;
            background-repeat: repeat;
            background-size: 300px 300px;
            box-shadow: inset 0 0 0 4px #5a3f2e;
            transform-origin: 0 0;  /* ä½¿ç”¨å·¦ä¸Šè§’ä½œä¸ºå˜æ¢åŸç‚¹ï¼Œä¾¿äºç¼©æ”¾ */
            will-change: transform;
            cursor: grab;
            transition: opacity 0.1s, cursor 0.1s;
        }
        .wall:active {
            cursor: grabbing;
            opacity: 0.95;
        }
        


        /* ä¾¿ç­¾ç»Ÿä¸€æ ·å¼ â€” å°ºå¯¸å¯ä¿®æ”¹ */
        .note {
            position: absolute;
            /* ===== ä¾¿ç­¾ç»Ÿä¸€å®½åº¦/æœ€å°é«˜åº¦ (ä¿®æ”¹æ­¤å¤„) ===== */
            width: 200px;                /* ä¿®æ”¹å®½åº¦ */
            min-height: 180px;            /* ä¿®æ”¹æœ€å°é«˜åº¦ */
            background-color: #fffacd; /* å„ style-* / has-image-bg ç±»ä¼šè¦†ç›– */
            border-bottom: 4px solid #d4b57e;
            border-right: 4px solid #c7a36b;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffff0 inset;
            padding: 20px 15px 15px 20px;
            font-family: 'Segoe UI', 'Comic Sans MS', 'Marker Felt', cursive;
            font-size: 1rem;
            line-height: 1.5;
            color: #2d241b;
            border-radius: 5px 20px 12px 8px;
            transform-origin: 0 0;
            transition: box-shadow 0.1s, filter 0.1s;
            cursor: grab;
            word-wrap: break-word;
            z-index: 1;
            will-change: left, top;
            overflow: hidden;
            touch-action: none; /* è®©æ‹–æ‹½è‡ªå·±å¤„ç†è§¦æ‘¸äº‹ä»¶ */
        }
        
        /* å¸¦å›¾ç‰‡èƒŒæ™¯çš„ä¾¿ç­¾ */
        .note.has-image-bg {
            background-color: #d6e8f5; /* å›¾ç‰‡åŠ è½½å‰/å¤±è´¥çš„é™çº§è‰² */
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            position: relative;
        }
        /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æç¤º */
        .note.has-image-bg.img-error {
            background-color: #f0e8d8;
            background-image: none !important;
        }
        .note.has-image-bg.img-error::after {
            content: "ğŸ–¼ï¸";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            opacity: 0.3;
            pointer-events: none;
        }
        
        /* å›¾ç‰‡èƒŒæ™¯ä¾¿ç­¾çš„å†…å®¹è¦†ç›–å±‚ */
        .note.has-image-bg .note-content {
            background: rgba(255, 255, 255, 0.88);
            padding: 15px;
            border-radius: 4px;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }
        
        /* ä¾¿ç­¾æ ·å¼ - yellow */
        .note.style-yellow {
            background-color: #fffacd; /* å„ style-* / has-image-bg ç±»ä¼šè¦†ç›– */
            border-bottom: 4px solid #d4b57e;
            border-right: 4px solid #c7a36b;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffff0 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - blue */
        .note.style-blue {
            background: #e6f7ff;
            background: linear-gradient(145deg, #f0f9ff, #d6f0ff);
            border-bottom: 4px solid #91d5ff;
            border-right: 4px solid #69c0ff;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0f9ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - green */
        .note.style-green {
            background: #f6ffed;
            background: linear-gradient(145deg, #f9fff2, #e8f5e8);
            border-bottom: 4px solid #b7eb8f;
            border-right: 4px solid #95de64;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f9fff2 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - pink */
        .note.style-pink {
            background: #fff0f6;
            background: linear-gradient(145deg, #fff5f8, #ffd6e7);
            border-bottom: 4px solid #ffadd2;
            border-right: 4px solid #ff85c0;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fff5f8 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - red */
        .note.style-red {
            background: #fff0f0;
            background: linear-gradient(145deg, #fff5f5, #ffd6d6);
            border-bottom: 4px solid #ff8585;
            border-right: 4px solid #ff5c5c;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fff5f5 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - purple */
        .note.style-purple {
            background: #f9f0ff;
            background: linear-gradient(145deg, #fcf5ff, #f0d6ff);
            border-bottom: 4px solid #d3adf7;
            border-right: 4px solid #b37feb;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fcf5ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - orange */
        .note.style-orange {
            background: #fff7e6;
            background: linear-gradient(145deg, #fffbf0, #ffd6b3);
            border-bottom: 4px solid #ffc599;
            border-right: 4px solid #ffa94d;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffbf0 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - teal */
        .note.style-teal {
            background: #e6fffb;
            background: linear-gradient(145deg, #f0fffb, #b3ffe6);
            border-bottom: 4px solid #85e6d9;
            border-right: 4px solid #5cdbd3;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0fffb inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - indigo */
        .note.style-indigo {
            background: #f0f5ff;
            background: linear-gradient(145deg, #f5f9ff, #d6e4ff);
            border-bottom: 4px solid #adc6ff;
            border-right: 4px solid #86a8ff;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f5f9ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - lime */
        .note.style-lime {
            background: #fafff0;
            background: linear-gradient(145deg, #fdfef9, #e8f5c8);
            border-bottom: 4px solid #e6ff70;
            border-right: 4px solid #d3f975;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fdfef9 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - cyan */
        .note.style-cyan {
            background: #e6ffff;
            background: linear-gradient(145deg, #f0ffff, #b3ffff);
            border-bottom: 4px solid #85ffff;
            border-right: 4px solid #5cdede;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0ffff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - amber */
        .note.style-amber {
            background: #fffbe6;
            background: linear-gradient(145deg, #fefcf0, #ffefb3);
            border-bottom: 4px solid #ffd591;
            border-right: 4px solid #ffc14d;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fefcf0 inset;
        }
        
        /* è‡ªå®šä¹‰é¢œè‰²ä¾¿ç­¾ */
        .note.custom-color {
            border-bottom: 4px solid rgba(0,0,0,0.2);
            border-right: 4px solid rgba(0,0,0,0.3);
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 rgba(255,255,255,0.3) inset;
        }
        .note:hover {
            filter: brightness(1.02);
            box-shadow: 10px 10px 22px rgba(0,0,0,0.5), 0 0 0 2px #fceeb6;
            cursor: grab;
        }
        .note:active {
            cursor: grabbing;
            z-index: 9999 !important;
            box-shadow: 14px 14px 25px rgba(0,0,0,0.6);
        }
        /* å°æŠ˜è§’ */
        .note::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 35px 35px 0;
            border-color: transparent #cfb07c transparent transparent;
            opacity: 0.6;
            pointer-events: none;
        }
        /* ä¾¿ç­¾å†…å®¹åŒºåŸŸ â€” æ¸²æŸ“ Markdown */
        .note-content {
            display: block;
            width: 100%;
            height: 100%;
            white-space: normal;
            word-break: break-word;
        }
        .note-content p {
            margin: 0 0 8px 0;
        }
        .note-content ul, .note-content ol {
            margin: 4px 0 4px 20px;
        }
        .note-content a {
            color: #a55808;
            text-decoration: underline;
            cursor: pointer;
        }

        /* ç¼©æ”¾æ§åˆ¶æ¡ â€” å³ä¸‹è§’å›ºå®šï¼Œç§»åŠ¨ç«¯å‹å¥½ */
        .zoom-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(45, 36, 30, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 20px;
            border-radius: 40px;
            border: 2px solid #bb9d7b;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 20000;
            color: #f7e3c2;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            font-size: 1rem;
            touch-action: manipulation;
        }
        .zoom-control label {
            font-size: 1.3rem;
            font-weight: bold;
            line-height: 1;
        }
        .zoom-control input {
            width: 200px;
            height: 10px;
            background: #4f3e2e;
            border-radius: 20px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            touch-action: manipulation;
        }
        .zoom-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: #f7d9a0;
            border-radius: 50%;
            border: 2px solid #7b5b3e;
            box-shadow: 0 2px 8px black;
            cursor: grab;
            touch-action: manipulation;
        }
        .zoom-control input::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: #f7d9a0;
            border-radius: 50%;
            border: 2px solid #7b5b3e;
            cursor: grab;
            touch-action: manipulation;
        }
        .zoom-control span {
            min-width: 65px;
            font-size: 1.3rem;
            background: #2d1f14;
            padding: 5px 12px;
            border-radius: 40px;
            text-align: center;
            border: 1px solid #c8a87c;
        }

        /* ä¿¡æ¯å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300000;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 15px;
        }
        .modal-box {
            background: #fef7e9;
            max-width: 500px;
            width: 100%;
            padding: 25px 20px;
            border-radius: 40px 15px 40px 15px;
            box-shadow: 0 30px 40px rgba(0,0,0,0.6), 0 10px 0 #bc9f7e inset;
            text-align: left;
            border: 5px solid #dac29c;
            font-size: 1rem;
            color: #3f2e1f;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-box h2 {
            margin: 0 0 15px 0;
            font-weight: 400;
            color: #4a3322;
            font-size: 2rem;
            border-bottom: 2px dashed #b48c65;
            padding-bottom: 8px;
        }
        .modal-box ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        .modal-box li {
            margin: 8px 0;
        }
        .modal-box code {
            background: #2d241e;
            color: #fadfad;
            padding: 2px 8px;
            border-radius: 30px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .modal-close {
            background: #b48c65;
            border: none;
            border-bottom: 5px solid #7b5b3e;
            padding: 12px 30px;
            border-radius: 40px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.1s;
            margin-top: 15px;
            display: block;
            margin-left: auto;
            touch-action: manipulation;
        }
        .modal-close:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }
        .hidden {
            display: none;
        }

        /* ç§»åŠ¨ç«¯è°ƒæ•´æ»‘å—å®½åº¦ */
        @media (max-width: 600px) {
            .zoom-control {
                padding: 10px 15px;
                gap: 10px;
                bottom: 15px;
                right: 15px;
            }
            .zoom-control input {
                width: 130px;
            }
            .zoom-control span {
                min-width: 55px;
                font-size: 1.1rem;
            }
            .zoom-control label {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- æ»šåŠ¨å®¹å™¨ -->
    <div class="wall-wrapper" id="wallWrapper">
        <!-- å·¨å¢™ (10000x10000) -->
        <div class="wall" id="wall"></div>
    </div>

    <!-- ç¼©æ”¾æ»‘å— (å³ä¸‹è§’) -->
    <div class="zoom-control">
        <label>ğŸ”</label>
        <input type="range" id="zoomSlider" min="0.4" max="3" step="0.02" value="1">
        <span id="zoomPercent">100%</span>
    </div>

    <!-- å¼¹çª— (ä½¿ç”¨è¯´æ˜) -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal-box">
            <h2>ğŸ§± ä»»æ„å¢™ Â· ä¸­å¿ƒç¼©æ”¾ç‰ˆ</h2>
            <ul>
                <li><strong>ğŸ“ ä¾¿ç­¾å°ºå¯¸</strong>ï¼šä¿®æ”¹ <code>.note</code> ä¸­çš„ <code>width</code> å’Œ <code>min-height</code> æ•°å€¼ã€‚</li>
                <li><strong>ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡</strong>ï¼šä¿®æ”¹ <code>.wall</code> ä¸­çš„ <code>background-image</code> é“¾æ¥ã€‚</li>
                <li><strong>ğŸ“ Markdown</strong>ï¼šä¾¿ç­¾å†…å®¹å·²æ”¯æŒ Markdown (å¦‚ **ç²—ä½“**ã€- åˆ—è¡¨ã€[é“¾æ¥] ç­‰)ã€‚</li>
                <li><strong>â• æ·»åŠ ä¾¿ç­¾</strong>ï¼šåœ¨ <code>initDefaultNotes()</code> çš„ <code>notesData</code> æ•°ç»„é‡Œè¿½åŠ æ–°å¯¹è±¡ã€‚</li>
                <li><strong>ğŸ” ä¸­å¿ƒç¼©æ”¾</strong>ï¼šæ»‘å—ç¼©æ”¾å§‹ç»ˆä»¥å±å¹•ä¸­å¿ƒä¸ºåŸºå‡†ï¼Œä¸ä¼šâ€œè·‘å‡ºå¢™å¤–â€ã€‚</li>
                <li><strong>ğŸ“± å¤šç«¯é€‚é…</strong>ï¼šæ»‘å—å³ä¸‹è§’ï¼Œç§»åŠ¨ç«¯è§¦æ‘¸å‹å¥½ã€‚</li>
            </ul>
            <button class="modal-close" id="closeModalBtn">å¼€å§‹ä½“éªŒ</button>
        </div>
    </div>

    <script>
        (function() {
            // å¢™é¢å¤§å°é…ç½® - å¯ä»¥è½»æ¾ä¿®æ”¹è¿™é‡Œæ¥æ”¹å˜å¢™é¢å°ºå¯¸
            const WALL_WIDTH = 10000;
            const WALL_HEIGHT = 10000;

            const wall = document.getElementById('wall');
            const wrapper = document.getElementById('wallWrapper');
            const slider = document.getElementById('zoomSlider');
            const zoomSpan = document.getElementById('zoomPercent');

            // è®¾ç½®å¢™é¢å¤§å°
            wall.style.width = WALL_WIDTH + 'px';
            wall.style.height = WALL_HEIGHT + 'px';

            let maxZIndex = 1000;
            let currentScale = 1.0; // å½“å‰ç¼©æ”¾å€¼

            // å·¥å…·å‡½æ•°ï¼šéšæœºèŒƒå›´
            const random = (min, max) => Math.random() * (max - min) + min;

            // Markdown æ¸²æŸ“ (ä½¿ç”¨ marked)
            function renderMarkdown(text) {
                if (typeof marked === 'undefined') return text;
                try {
                    return marked.parse(text);
                } catch (e) {
                    return text;
                }
            }

            // åˆ›å»ºä¾¿ç­¾ (æ”¯æŒç»Ÿä¸€çš„styleå±æ€§)
            function createNote(mdText, left, top, rotate = null, style = 'yellow') {
                const note = document.createElement('div');
                note.className = 'note';

                // å¤„ç†ç»Ÿä¸€çš„styleå±æ€§
                if (typeof style === 'string') {
                    if (style.startsWith('http') || style.startsWith('//')) {
                        // â”€â”€ å›¾ç‰‡èƒŒæ™¯ï¼šç”¨ Image å¯¹è±¡é¢„åŠ è½½ï¼ŒåŠ è½½æˆåŠŸå†è®¾ç½®ï¼Œå¤±è´¥æ—¶é™çº§ â”€â”€
                        note.classList.add('has-image-bg');
                        const img = new Image();
                        img.onload = () => {
                            // åŠ è½½æˆåŠŸï¼šé€šè¿‡ style å±æ€§ç›´æ¥è®¾ç½®ï¼Œä¼˜å…ˆçº§é«˜äº CSS
                            note.style.setProperty('background-image', `url("${style}")`, 'important');
                        };
                        img.onerror = () => {
                            // åŠ è½½å¤±è´¥ï¼šæ ‡è®°é”™è¯¯çŠ¶æ€ï¼Œæ˜¾ç¤ºé™çº§æ ·å¼
                            note.classList.add('img-error');
                        };
                        // è®¾ç½®è·¨åŸŸå±æ€§å†èµ‹ srcï¼Œé¿å…æŸäº› CDN çš„ CORS é—®é¢˜
                        img.crossOrigin = 'anonymous';
                        img.src = style;
                        // è‹¥å›¾ç‰‡å·²åœ¨ç¼“å­˜ä¸­ä¼šåŒæ­¥è§¦å‘ onloadï¼Œæ­¤å¤„æ— éœ€é¢å¤–å¤„ç†
                    } else if (style.startsWith('#')) {
                        // è‡ªå®šä¹‰é¢œè‰²
                        note.classList.add('custom-color');
                        note.style.background = `linear-gradient(145deg, ${lightenColor(style, 5)}, ${darkenColor(style, 5)})`;
                    } else {
                        // é¢„è®¾æ ·å¼ï¼ˆä½¿ç”¨é¢œè‰²åå­—ï¼‰
                        note.classList.add(`style-${style}`);
                    }
                } else {
                    note.classList.add('style-yellow');
                }

                // éšæœºè§’åº¦ï¼ˆå¦‚æœæœªæä¾›ï¼‰
                const rot = (rotate !== null) ? rotate : random(-5, 6);
                note.style.transform = `rotate(${rot}deg)`;

                // éšæœºä½ç½®ï¼ˆå¦‚æœæœªæä¾›ï¼‰
                const noteLeft = left !== null ? left : random(200, WALL_WIDTH - 200);
                const noteTop  = top  !== null ? top  : random(200, WALL_HEIGHT - 200);
                note.style.left = noteLeft + 'px';
                note.style.top  = noteTop  + 'px';

                const contentSpan = document.createElement('span');
                contentSpan.className = 'note-content';
                contentSpan.innerHTML = renderMarkdown(mdText);
                note.appendChild(contentSpan);

                note.style.zIndex = Math.floor(random(10, 500));

                makeDraggable(note);
                return note;
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´é¢œè‰²äº®åº¦
            function lightenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
            }
            
            function darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R>255?255:R<0?0:R)*0x10000 + (G>255?255:G<0?0:G)*0x100 + (B>255?255:B<0?0:B)).toString(16).slice(1);
            }

            // æ‹–æ‹½é€»è¾‘ (æ·»åŠ ç²˜æ»æ•ˆæœ)
            function makeDraggable(element) {
                let isDragging = false;
                let startX, startY;
                let initialLeft, initialTop;
                let hasMoved = false;
                let lastX, lastY; // è®°å½•ä¸Šä¸€æ¬¡é¼ æ ‡ä½ç½®
                let velocity = { x: 0, y: 0 }; // è®°å½•æ‹–åŠ¨é€Ÿåº¦
                let lastTime = 0; // è®°å½•ä¸Šä¸€æ¬¡æ—¶é—´

                function getPosition() {
                    const left = parseFloat(element.style.left) || 0;
                    const top = parseFloat(element.style.top) || 0;
                    return { left, top };
                }

                function onDragStart(e) {
                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è¶…é“¾æ¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å¯åŠ¨æ‹–æ‹½
                    let target = e.target;
                    while (target) {
                        if (target.tagName === 'A') {
                            return; // æ˜¯è¶…é“¾æ¥ï¼Œä¸å¯åŠ¨æ‹–æ‹½
                        }
                        target = target.parentElement;
                        if (target === element) break;
                    }

                    if (e.button !== undefined && e.button !== 0) return;
                    e.preventDefault();
                    e.stopPropagation();

                    let clientX, clientY;
                    if (e.type === 'mousedown') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else if (e.type === 'touchstart') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        return;
                    }

                    startX = clientX;
                    startY = clientY;
                    lastX = clientX;
                    lastY = clientY;
                    lastTime = Date.now();
                    velocity = { x: 0, y: 0 };

                    const pos = getPosition();
                    initialLeft = pos.left;
                    initialTop = pos.top;

                    isDragging = true;
                    hasMoved = false;

                    maxZIndex += 1;
                    element.style.zIndex = maxZIndex;
                    element.style.transition = 'none'; // æ‹–åŠ¨æ—¶ç¦ç”¨è¿‡æ¸¡æ•ˆæœ

                    document.addEventListener('mousemove', onDragMove);
                    document.addEventListener('mouseup', onDragEnd);
                    document.addEventListener('touchmove', onDragMove, { passive: false });
                    document.addEventListener('touchend', onDragEnd);
                    document.addEventListener('touchcancel', onDragCancel);
                }

                function onDragMove(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    let clientX, clientY;
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else if (e.type === 'touchmove') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        return;
                    }

                    // è®¡ç®—é€Ÿåº¦
                    const currentTime = Date.now();
                    const deltaTime = currentTime - lastTime;
                    if (deltaTime > 0) {
                        velocity.x = (clientX - lastX) / deltaTime * 16; // æ ‡å‡†åŒ–åˆ°60fps
                        velocity.y = (clientY - lastY) / deltaTime * 16;
                    }

                    lastX = clientX;
                    lastY = clientY;
                    lastTime = currentTime;

                    const dx = clientX - startX;
                    const dy = clientY - startY;

                    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

                    let newLeft = initialLeft + dx;
                    let newTop = initialTop + dy;

                    // è½¯é™åˆ¶ (ä¾¿ç­¾ä¸èƒ½å®Œå…¨ç¦»å¼€å¢™)
                    const minX = -element.offsetWidth + 30;
                    const maxX = WALL_WIDTH - 30;
                    const minY = -element.offsetHeight + 30;
                    const maxY = WALL_HEIGHT - 30;
                    newLeft = Math.min(maxX, Math.max(minX, newLeft));
                    newTop = Math.min(maxY, Math.max(minY, newTop));

                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';
                }

                function onDragEnd(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    document.removeEventListener('mousemove', onDragMove);
                    document.removeEventListener('mouseup', onDragEnd);
                    document.removeEventListener('touchmove', onDragMove);
                    document.removeEventListener('touchend', onDragEnd);
                    document.removeEventListener('touchcancel', onDragCancel);
                    isDragging = false;

                    // åº”ç”¨ç²˜æ»æ•ˆæœ
                    if (hasMoved) {
                        applyStickyEffect();
                    }
                }

                function applyStickyEffect() {
                    // å¯ç”¨è¿‡æ¸¡æ•ˆæœ
                    element.style.transition = 'left 0.3s ease-out, top 0.3s ease-out';

                    // è·å–å½“å‰ä½ç½®
                    const pos = getPosition();
                    let newLeft = pos.left + velocity.x * 0.5; // åº”ç”¨é€Ÿåº¦è¡°å‡
                    let newTop = pos.top + velocity.y * 0.5;

                    // è½¯é™åˆ¶ (ä¾¿ç­¾ä¸èƒ½å®Œå…¨ç¦»å¼€å¢™)
                    const minX = -element.offsetWidth + 30;
                    const maxX = WALL_WIDTH - 30;
                    const minY = -element.offsetHeight + 30;
                    const maxY = WALL_HEIGHT - 30;
                    newLeft = Math.min(maxX, Math.max(minX, newLeft));
                    newTop = Math.min(maxY, Math.max(minY, newTop));

                    // åº”ç”¨æ–°ä½ç½®
                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';

                    // è¿‡æ¸¡ç»“æŸåç¦ç”¨è¿‡æ¸¡æ•ˆæœ
                    setTimeout(() => {
                        element.style.transition = 'none';
                    }, 300);
                }

                function onDragCancel(e) {
                    onDragEnd(e);
                }

                element.addEventListener('mousedown', onDragStart);
                element.addEventListener('touchstart', onDragStart, { passive: false });
            }

            // åˆå§‹åŒ–ä¾¿ç­¾ (æ”¯æŒ Markdownã€å›¾ç‰‡èƒŒæ™¯ã€é¢œè‰²å’Œæ ·å¼)
            function initDefaultNotes(data = null) {
                if (!data || !data.notes) return;
                data.notes.forEach((item) => {
                    const note = createNote(
                        item.text,
                        null, // éšæœºä½ç½®
                        null,
                        null, // éšæœºè§’åº¦
                        item.style || 'yellow'
                    );
                    wall.appendChild(note);
                });
            }

            // è®¾å¤‡æ£€æµ‹
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            const mobileDevice = isMobileDevice();
            
            // å­˜å‚¨å…‰æ ‡ä½ç½®
            let cursorPos = { x: 0, y: 0 };
            
            // æ›´æ–°å…‰æ ‡ä½ç½®
            wrapper.addEventListener('mousemove', (e) => {
                cursorPos.x = e.clientX;
                cursorPos.y = e.clientY;
            });

            // ========== ç¼©æ”¾é€»è¾‘ (æ”¯æŒè·Ÿéšå…‰æ ‡ï¼Œä¸å‡ºç•Œ) ==========
            // æ³¨æ„ï¼šwrapper.scrollLeft/scrollTop å·¥ä½œåœ¨"ç¼©æ”¾ååƒç´ "åæ ‡ç³»ä¸­ã€‚
            // å¢™ç»è¿‡ scale(s) åï¼Œå…¶å®é™…å ç”¨å®½åº¦ = WALL_WIDTH * sï¼Œ
            // æ‰€ä»¥ maxScrollLeft = WALL_WIDTH * s - vwï¼Œå•ä½éƒ½æ˜¯å±å¹•åƒç´ ã€‚
            function updateZoom(newScale, useCursor = false) {
                const vw = wrapper.clientWidth;
                const vh = wrapper.clientHeight;
                if (vw === 0 || vh === 0) return;

                const oldScale = currentScale;

                // ç¼©æ”¾åå¢™çš„å®é™…å±å¹•åƒç´ å°ºå¯¸
                const scaledW = WALL_WIDTH * newScale;
                const scaledH = WALL_HEIGHT * newScale;

                // ç¡®å®š"é”šç‚¹"ï¼šç¼©æ”¾å‰åè¯¥ç‚¹åœ¨å±å¹•ä¸Šä¿æŒä¸åŠ¨
                // focusX/Y æ˜¯è§†å£å†…çš„å±å¹•åæ ‡ï¼ˆåƒç´ ï¼‰
                let focusX, focusY;
                if (useCursor && !mobileDevice) {
                    focusX = cursorPos.x;
                    focusY = cursorPos.y;
                } else {
                    // ä»¥è§†å£ä¸­å¿ƒä¸ºé”šç‚¹
                    focusX = vw / 2;
                    focusY = vh / 2;
                }

                // é”šç‚¹åœ¨ç¼©æ”¾å‰å¢™é¢ä¸Šçš„ç»å¯¹ä½ç½®ï¼ˆå¢™åæ ‡ç³»ï¼Œå•ä½ï¼šå¢™åƒç´ ï¼‰
                // å½“å‰ scrollLeft/Top æ˜¯å±å¹•åƒç´ ï¼Œé™¤ä»¥ oldScale å¾—åˆ°å¢™åæ ‡
                const anchorWallX = (wrapper.scrollLeft + focusX) / oldScale;
                const anchorWallY = (wrapper.scrollTop + focusY) / oldScale;

                // ç¼©æ”¾åï¼Œä¸ºäº†è®©é”šç‚¹ä»ä½äºå±å¹•ä¸ŠåŒä¸€ä½ç½®ï¼Œæ–°çš„ scrollLeft/Topï¼š
                let newScrollLeft = anchorWallX * newScale - focusX;
                let newScrollTop  = anchorWallY * newScale - focusY;

                // é™åˆ¶æ»šåŠ¨èŒƒå›´ï¼Œç¡®ä¿ä¸ä¼šè¶…å‡ºå¢™é¢è¾¹ç•Œ
                // æœ€å¤§æ»šåŠ¨ = ç¼©æ”¾åå¢™å°ºå¯¸ - è§†å£å°ºå¯¸ï¼›è‹¥å¢™æ¯”è§†å£å°åˆ™å±…ä¸­
                const maxScrollLeft = Math.max(0, scaledW - vw);
                const maxScrollTop  = Math.max(0, scaledH - vh);

                if (scaledW <= vw) {
                    // å¢™æ¯”è§†å£çª„æ—¶æ°´å¹³å±…ä¸­
                    newScrollLeft = -(vw - scaledW) / 2;
                } else {
                    newScrollLeft = Math.max(0, Math.min(maxScrollLeft, newScrollLeft));
                }

                if (scaledH <= vh) {
                    // å¢™æ¯”è§†å£çŸ®æ—¶å‚ç›´å±…ä¸­
                    newScrollTop = -(vh - scaledH) / 2;
                } else {
                    newScrollTop = Math.max(0, Math.min(maxScrollTop, newScrollTop));
                }

                // åº”ç”¨ç¼©æ”¾ï¼Œç„¶åè®¾ç½®æ»šåŠ¨ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰
                wall.style.transform = `scale(${newScale})`;
                wrapper.scrollLeft = newScrollLeft;
                wrapper.scrollTop  = newScrollTop;

                // æ›´æ–°å½“å‰ç¼©æ”¾å€¼
                currentScale = newScale;
                zoomSpan.innerText = Math.round(newScale * 100) + '%';
            }

            // æ»‘å—äº‹ä»¶
            slider.addEventListener('input', (e) => {
                const newScale = parseFloat(e.target.value);
                updateZoom(newScale, !mobileDevice); // æ ¹æ®è®¾å¤‡ç±»å‹å†³å®šæ˜¯å¦ä½¿ç”¨å…‰æ ‡è·Ÿéšç¼©æ”¾
            });

            // åˆå§‹ç¼©æ”¾ä¸æ»šåŠ¨ (ä½¿å¢™ä¸­é—´åŒºåŸŸå¯è§)
            window.addEventListener('load', async () => {
                makeWallDraggable(); // å¯ç”¨å¢™é¢æ‹–åŠ¨åŠŸèƒ½

                // åŠ è½½å¤–éƒ¨ä¾¿ç­¾æ•°æ®ï¼Œæ·»åŠ æ—¶é—´æˆ³å‚æ•°ç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬
                try {
                    const response = await fetch(`notes-data.json?t=${Date.now()}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    initDefaultNotes(data);
                } catch (error) {
                    console.warn('æ— æ³•åŠ è½½ä¾¿ç­¾æ•°æ®:', error.message);
                }
                
                // è®¾ç½®åˆå§‹ç¼©æ”¾ä¸º1ï¼Œå¹¶æ»šåŠ¨åˆ°å¢™é¢ä¸­å¿ƒ
                setTimeout(() => {
                    const vw = wrapper.clientWidth;
                    const vh = wrapper.clientHeight;

                    // ç¡®ä¿æ»‘å—ä¸ç¼©æ”¾åŒæ­¥
                    slider.value = currentScale;
                    zoomSpan.innerText = Math.round(currentScale * 100) + '%';

                    // ç¼©æ”¾åå¢™çš„å±å¹•åƒç´ å°ºå¯¸ï¼ˆscale=1 æ—¶ç­‰äºå¢™å°ºå¯¸ï¼‰
                    const scaledW = WALL_WIDTH * currentScale;
                    const scaledH = WALL_HEIGHT * currentScale;

                    // è®©å¢™é¢ä¸­å¿ƒå¯¹å‡†è§†å£ä¸­å¿ƒï¼ˆç¼©æ”¾ååƒç´ åæ ‡ç³»ï¼‰
                    const targetScrollLeft = (scaledW / 2) - (vw / 2);
                    const targetScrollTop  = (scaledH / 2) - (vh / 2);

                    wall.style.transform = `scale(${currentScale})`;
                    wrapper.scrollLeft = Math.max(0, Math.min(scaledW - vw, targetScrollLeft));
                    wrapper.scrollTop  = Math.max(0, Math.min(scaledH - vh, targetScrollTop));
                }, 100);
            });

            // å¢™é¢æ‹–åŠ¨åŠŸèƒ½
            function makeWallDraggable() {
                let isDragging = false;
                let startX, startY;
                let initialScrollLeft, initialScrollTop;

                function onDragStart(e) {
                    // åªæœ‰ç‚¹å‡»å¢™é¢ç©ºç™½åŒºåŸŸæ‰è§¦å‘æ‹–åŠ¨
                    if (e.target === wall || e.target === wrapper) {
                        if (e.button !== undefined && e.button !== 0) return;
                        e.preventDefault();
                        e.stopPropagation();

                        let clientX, clientY;
                        if (e.type === 'mousedown') {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        } else if (e.type === 'touchstart') {
                            clientX = e.touches[0].clientX;
                            clientY = e.touches[0].clientY;
                        } else {
                            return;
                        }

                        startX = clientX;
                        startY = clientY;
                        initialScrollLeft = wrapper.scrollLeft;
                        initialScrollTop = wrapper.scrollTop;

                        isDragging = true;

                        document.addEventListener('mousemove', onDragMove);
                        document.addEventListener('mouseup', onDragEnd);
                        document.addEventListener('touchmove', onDragMove, { passive: false });
                        document.addEventListener('touchend', onDragEnd);
                        document.addEventListener('touchcancel', onDragCancel);
                    }
                }

                function onDragMove(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    let clientX, clientY;
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else if (e.type === 'touchmove') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        return;
                    }

                    const dx = clientX - startX;
                    const dy = clientY - startY;

                    // scrollLeft/Top åœ¨å±å¹•åƒç´ åæ ‡ç³»ï¼Œé¼ æ ‡ç§»åŠ¨é‡ dx/dy ä¹Ÿæ˜¯å±å¹•åƒç´ ï¼Œç›´æ¥ç›¸å‡å³å¯
                    const newScrollLeft = initialScrollLeft - dx;
                    const newScrollTop  = initialScrollTop  - dy;

                    // åº”ç”¨æ»šåŠ¨ä½ç½®
                    wrapper.scrollLeft = newScrollLeft;
                    wrapper.scrollTop  = newScrollTop;
                }

                function onDragEnd(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    e.stopPropagation();

                    document.removeEventListener('mousemove', onDragMove);
                    document.removeEventListener('mouseup', onDragEnd);
                    document.removeEventListener('touchmove', onDragMove);
                    document.removeEventListener('touchend', onDragEnd);
                    document.removeEventListener('touchcancel', onDragCancel);
                    isDragging = false;
                }

                function onDragCancel(e) {
                    onDragEnd(e);
                }

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åˆ°å¢™é¢å’Œå®¹å™¨
                wall.addEventListener('mousedown', onDragStart);
                wall.addEventListener('touchstart', onDragStart, { passive: false });
                wrapper.addEventListener('mousedown', onDragStart);
                wrapper.addEventListener('touchstart', onDragStart, { passive: false });
            }

            // å¼¹çª—æ§åˆ¶
            const modal = document.getElementById('infoModal');
            const closeBtn = document.getElementById('closeModalBtn');
            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // é¼ æ ‡æ»šè½®ç¼©æ”¾åŠŸèƒ½
            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                // æ›´æ–°å…‰æ ‡ä½ç½®
                cursorPos.x = e.clientX;
                cursorPos.y = e.clientY;
                
                // è®¡ç®—ç¼©æ”¾å¢é‡ï¼Œæ ¹æ®æ»šè½®æ–¹å‘
                const delta = e.deltaY > 0 ? -0.05 : 0.05;
                let newScale = currentScale + delta;
                
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                newScale = Math.max(0.4, Math.min(3, newScale));
                
                // æ›´æ–°æ»‘å—å€¼
                slider.value = newScale;
                
                // æ ¹æ®è®¾å¤‡ç±»å‹å†³å®šæ˜¯å¦ä½¿ç”¨å…‰æ ‡è·Ÿéšç¼©æ”¾
                updateZoom(newScale, !mobileDevice);
            });

            // è§¦æ‘¸è®¾å¤‡åŒæŒ‡ç¼©æ”¾æ”¯æŒ
            let initialDistance = 0;
            let initialScale = 1;
            
            function handleTouchStart(e) {
                if (e.touches.length === 2) {
                    // è®¡ç®—åˆå§‹åŒæŒ‡è·ç¦»
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialScale = currentScale;
                }
            }
            
            function handleTouchMove(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    
                    // è®¡ç®—å½“å‰åŒæŒ‡è·ç¦»
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                    const scaleFactor = currentDistance / initialDistance;
                    let newScale = initialScale * scaleFactor;
                    
                    // é™åˆ¶ç¼©æ”¾èŒƒå›´
                    newScale = Math.max(0.4, Math.min(3, newScale));
                    
                    // æ›´æ–°æ»‘å—å€¼
                    slider.value = newScale;
                    
                    // åº”ç”¨ç¼©æ”¾
                    updateZoom(newScale);
                }
            }
            
            // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
            function getDistance(touch1, touch2) {
                const dx = touch2.clientX - touch1.clientX;
                const dy = touch2.clientY - touch1.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
            wrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
            wrapper.addEventListener('touchmove', handleTouchMove, { passive: false });

            // çª—å£resizeæ—¶ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æ»šåŠ¨è¾¹ç•Œ (ä¿æŒä¸­å¿ƒç‚¹ï¼Ÿä¸ºäº†ç®€åŒ–ï¼Œä¸åšé¢å¤–å¤„ç†ï¼Œä½†å¯ä¿æŒç¼©æ”¾ä¸å˜)
            // å¯é€‰ï¼šresize æ—¶é‡æ–°é™åˆ¶æ»šåŠ¨è¾¹ç•Œï¼Œä½†æ— éœ€æ›´æ”¹ç¼©æ”¾ã€‚
            window.addEventListener('resize', () => {
                // ä¿è¯æ»šåŠ¨ä½ç½®ä¸è¶Šç•Œï¼ˆåæ ‡ç³»ï¼šç¼©æ”¾åå±å¹•åƒç´ ï¼‰
                const vw = wrapper.clientWidth;
                const vh = wrapper.clientHeight;
                const scaledW = WALL_WIDTH * currentScale;
                const scaledH = WALL_HEIGHT * currentScale;
                const maxLeft = Math.max(0, scaledW - vw);
                const maxTop  = Math.max(0, scaledH - vh);
                wrapper.scrollLeft = Math.max(0, Math.min(maxLeft, wrapper.scrollLeft));
                wrapper.scrollTop  = Math.max(0, Math.min(maxTop,  wrapper.scrollTop));
            });
        })();
    </script>
</body>
</html>