<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>便签墙</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      overflow: hidden;
      background: #f0f2f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      touch-action: none; /* 阻止默认双指缩放 */
    }

    /* 墙体容器 */
    .wall-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .wall {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: 0 0;
      will-change: transform;
      backface-visibility: hidden;
      transform: translate(-50%, -50%) scale(1) translateZ(0);
    }

    /* 便签样式 */
    .note {
      position: absolute;
      width: 180px;
      min-height: 120px;
      padding: 8px;
      background: #fffde7;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
      cursor: move;
      user-select: text;
      contain: layout style paint;
      transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      transform-origin: 0 0;
    }

    /* 缩放控制条 */
    .zoom-control {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      width: 200px;
      background: white;
      padding: 8px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      pointer-events: auto;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .zoom-control input {
      width: 100%;
    }

    /* 弹窗 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    }
    .modal h2 {
      margin-bottom: 12px;
    }
    .modal p {
      line-height: 1.5;
    }
    .close-btn {
      margin-top: 12px;
      padding: 6px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="wall-wrapper">
  <div class="wall" id="wall"></div>
</div>

<div class="zoom-control">
  <input type="range" id="zoomSlider" min="0.1" max="2" step="0.05" value="1" />
</div>

<div class="modal" id="infoModal">
  <div class="modal-content">
    <h2>欢迎使用便签墙</h2>
    <p>你可以拖动便签、缩放墙面。数据自动保存到本地。</p>
    <button class="close-btn">我知道了</button>
  </div>
</div>

<script>
  // ======================
  // 工具函数
  // ======================
  function clamp(val, min, max) {
    return Math.min(Math.max(val, min), max);
  }

  // ======================
  // 墙体拖拽与缩放
  // ======================
  const wall = document.getElementById('wall');
  const zoomSlider = document.getElementById('zoomSlider');
  const wallWrapper = document.querySelector('.wall-wrapper');

  let wallX = 0, wallY = 0, scale = 1;
  let isDraggingWall = false;
  let lastX, lastY;

  function updateWallTransform() {
    wall.style.transform = `translate(-50%, -50%) translate(${wallX}px, ${wallY}px) scale(${scale}) translateZ(0)`;
  }

  // 墙体拖拽
  wallWrapper.addEventListener('mousedown', startDrag);
  wallWrapper.addEventListener('touchstart', e => {
    if (e.touches.length === 1) startDrag(e.touches);
  }, { passive: false });

  function startDrag(e) {
    const target = e.target;
    // 防止在滑块或弹窗上触发墙体拖拽
    if (target.closest('.zoom-control') || target.closest('.modal')) return;

    isDraggingWall = true;
    lastX = ('clientX' in e) ? e.clientX : e.pageX;
    lastY = ('clientY' in e) ? e.clientY : e.pageY;
    wallWrapper.style.cursor = 'grabbing';
    e.preventDefault();
  }

  window.addEventListener('mousemove', drag);
  window.addEventListener('touchmove', e => {
    if (isDraggingWall && e.touches.length === 1) {
      drag(e.touches);
      e.preventDefault();
    }
  }, { passive: false });

  function drag(e) {
    if (!isDraggingWall) return;
    const dx = (('clientX' in e) ? e.clientX : e.pageX) - lastX;
    const dy = (('clientY' in e) ? e.clientY : e.pageY) - lastY;
    wallX += dx;
    wallY += dy;
    lastX += dx;
    lastY += dy;
    updateWallTransform();
  }

  window.addEventListener('mouseup', endDrag);
  window.addEventListener('touchend', endDrag);

  function endDrag() {
    isDraggingWall = false;
    wallWrapper.style.cursor = 'default';
  }

  // 缩放控制
  zoomSlider.addEventListener('input', () => {
    scale = clamp(parseFloat(zoomSlider.value), 0.1, 2);
    updateWallTransform();
  });

  // ======================
  // 便签管理
  // ======================
  let notes = [];
  let noteIdCounter = 0;

  function createNote(data = {}) {
    const note = document.createElement('div');
    note.className = 'note';
    note.draggable = false; // 禁用原生拖拽
    note.contentEditable = true;
    note.textContent = data.text || '点击编辑...';

    const x = data.x ?? Math.random() * 1000 - 200;
    const y = data.y ?? Math.random() * 600 - 100;
    note.style.left = x + 'px';
    note.style.top = y + 'px';

    const id = data.id ?? ++noteIdCounter;
    note.dataset.id = id;

    // 便签拖拽
    let isDraggingNote = false;
    let offsetX, offsetY;

    note.addEventListener('mousedown', e => {
      if (e.target !== note) return; // 只在便签空白处拖拽
      isDraggingNote = true;
      const rect = note.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      note.style.zIndex = '1000';
      e.stopPropagation();
    });

    note.addEventListener('touchstart', e => {
      if (e.target !== note || e.touches.length > 1) return;
      isDraggingNote = true;
      const rect = note.getBoundingClientRect();
      offsetX = e.touches.clientX - rect.left;
      offsetY = e.touches.clientY - rect.top;
      note.style.zIndex = '1000';
      e.stopPropagation();
    }, { passive: false });

    function moveNote(clientX, clientY) {
      if (!isDraggingNote) return;
      const wallRect = wall.getBoundingClientRect();
      const scaleX = scale;
      const scaleY = scale;
      const relX = (clientX - wallRect.left - wallX) / scaleX;
      const relY = (clientY - wallRect.top - wallY) / scaleY;
      note.style.left = (relX - offsetX) + 'px';
      note.style.top = (relY - offsetY) + 'px';
    }

    window.addEventListener('mousemove', e => moveNote(e.clientX, e.clientY));
    window.addEventListener('touchmove', e => {
      if (isDraggingNote && e.touches.length === 1) {
        moveNote(e.touches.clientX, e.touches.clientY);
        e.preventDefault();
      }
    }, { passive: false });

    window.addEventListener('mouseup', () => isDraggingNote = false);
    window.addEventListener('touchend', () => isDraggingNote = false);

    // 内容变更保存
    note.addEventListener('input', saveNotesDebounced);

    wall.appendChild(note);
    notes.push({ id, element: note });
  }

  // ======================
  // 数据持久化
  // ======================
  function saveNotes() {
    const data = notes.map(n => {
      const el = n.element;
      return {
        id: n.id,
        text: el.textContent,
        x: parseFloat(el.style.left),
        y: parseFloat(el.style.top)
      };
    });
    localStorage.setItem('sticky-notes-data', JSON.stringify(data));
  }

  let saveTimer;
  function saveNotesDebounced() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNotes, 500);
  }

  function loadNotes() {
    try {
      const saved = localStorage.getItem('sticky-notes-data');
      if (saved) {
        const data = JSON.parse(saved);
        data.forEach(createNote);
        noteIdCounter = Math.max(...data.map(d => d.id), 0);
      } else {
        // 初始便签
        createNote({ text: '欢迎使用！\n拖拽我试试~', x: 0, y: 0 });
      }
    } catch (e) {
      console.error('加载便签失败', e);
      createNote({ text: '初始化便签', x: 0, y: 0 });
    }
  }

  // ======================
  // 初始化
  // ======================
  window.addEventListener('DOMContentLoaded', () => {
    loadNotes();

    // 延迟显示弹窗，避免阻塞
    setTimeout(() => {
      const modal = document.getElementById('infoModal');
      modal.classList.add('show');
      modal.querySelector('.close-btn').addEventListener('click', () => {
        modal.classList.remove('show');
      });
    }, 300);
  });
</script>

</body>
</html>
