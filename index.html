<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¾¿ç­¾æŠ•ç¨¿å¢™</title>
    <!-- ä½¿ç”¨ marked è§£æ Markdown (è½»é‡, å®‰å…¨) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js" defer></script>
    <style>
        * {
            box-sizing: border-box;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­ */
            margin: 0;
            padding: 0;
        }
        body {
            background: #2d241e;
            font-family: 'Segoe UI', 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: pan-x pan-y pinch-zoom; /* å…è®¸å•æŒ‡å¹³ç§» + åŒæŒ‡ç¼©æ”¾ */
        }

        /* å…¨å±æ»šåŠ¨å®¹å™¨ */
        .wall-wrapper {
            width: 100vw;
            height: 100vh;
            overflow: auto;
            position: relative;
            touch-action: none; /* JS å®Œæ•´æ¥ç®¡æ‰€æœ‰è§¦æ‘¸æ‰‹åŠ¿ï¼ˆå•æŒ‡æ‹–åŠ¨ + åŒæŒ‡ç¼©æ”¾ï¼‰ */
            /* è“å¤©èƒŒæ™¯ï¼Œç¼©å°æ—¶æ˜¾ç¤ºç¾è§‚çš„å¤–ç•Œ */
            background: linear-gradient(to bottom, #87ceeb, #b0e0e6);
            -webkit-overflow-scrolling: touch; /* æµç•…æ»šåŠ¨ */
            cursor: grab;
        }
        .wall-wrapper:active {
            cursor: grabbing;
        }

        /* å·¨å¢™ â€” èƒŒæ™¯å›¾ç‰‡é“¾æ¥åœ¨æ­¤ä¿®æ”¹ */
        .wall {
            position: relative;
            width: 10000px;
            height: 10000px;
            /* ===== èƒŒæ™¯å›¾ç‰‡é“¾æ¥ ===== */
            background-image: url('https://www.transparenttextures.com/patterns/old-wall.png');  /* é»˜è®¤ç –çº¹å›¾ç‰‡ */
            background-color: #b08a67;
            background-repeat: repeat;
            background-size: 300px 300px;
            box-shadow: inset 0 0 0 4px #5a3f2e;
            transform-origin: 0 0;  /* ä½¿ç”¨å·¦ä¸Šè§’ä½œä¸ºå˜æ¢åŸç‚¹ï¼Œä¾¿äºç¼©æ”¾ */
            will-change: transform;
            cursor: grab;
        }
        .wall:active {
            cursor: grabbing;
        }
        


        /* ä¾¿ç­¾ç»Ÿä¸€æ ·å¼ â€” å°ºå¯¸å¯ä¿®æ”¹ */
        .note {
            position: absolute;
            width: 240px;
            min-height: 200px;
            background-color: #fffacd;
            border-bottom: 4px solid #d4b57e;
            border-right: 4px solid #c7a36b;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffff0 inset;
            padding: 18px 16px 32px 20px;  /* bottom ç•™ç»™ç½²åè¡Œ */
            font-family: 'Segoe UI', 'Comic Sans MS', 'Marker Felt', cursive;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #2d241b;
            border-radius: 5px 20px 12px 8px;
            transform-origin: 0 0;
            transition: box-shadow 0.1s, filter 0.1s;
            cursor: grab;
            word-wrap: break-word;
            z-index: 1;
            will-change: transform;  /* æ”¹ä¸º transformï¼Œæ‹–åŠ¨ç”¨ translate */
            overflow: hidden;
            touch-action: none;
            contain: layout style;   /* éš”ç¦» reflow å½±å“ */
        }
        
        /* å¸¦å›¾ç‰‡èƒŒæ™¯çš„ä¾¿ç­¾ */
        .note.has-image-bg {
            background-color: #d6e8f5; /* å›¾ç‰‡åŠ è½½å‰/å¤±è´¥çš„é™çº§è‰² */
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            position: relative;
        }
        /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æç¤º */
        .note.has-image-bg.img-error {
            background-color: #f0e8d8;
            background-image: none !important;
        }
        .note.has-image-bg.img-error::after {
            content: "ğŸ–¼ï¸";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            opacity: 0.3;
            pointer-events: none;
        }
        
        /* å›¾ç‰‡èƒŒæ™¯ä¾¿ç­¾çš„å†…å®¹è¦†ç›–å±‚ */
        .note.has-image-bg .note-content {
            background: rgba(255, 255, 255, 0.88);
            padding: 15px;
            border-radius: 4px;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }
        
        /* ä¾¿ç­¾æ ·å¼ - yellow */
        .note.style-yellow {
            background-color: #fffacd; /* å„ style-* / has-image-bg ç±»ä¼šè¦†ç›– */
            border-bottom: 4px solid #d4b57e;
            border-right: 4px solid #c7a36b;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffff0 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - blue */
        .note.style-blue {
            background: #e6f7ff;
            background: linear-gradient(145deg, #f0f9ff, #d6f0ff);
            border-bottom: 4px solid #91d5ff;
            border-right: 4px solid #69c0ff;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0f9ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - green */
        .note.style-green {
            background: #f6ffed;
            background: linear-gradient(145deg, #f9fff2, #e8f5e8);
            border-bottom: 4px solid #b7eb8f;
            border-right: 4px solid #95de64;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f9fff2 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - pink */
        .note.style-pink {
            background: #fff0f6;
            background: linear-gradient(145deg, #fff5f8, #ffd6e7);
            border-bottom: 4px solid #ffadd2;
            border-right: 4px solid #ff85c0;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fff5f8 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - red */
        .note.style-red {
            background: #fff0f0;
            background: linear-gradient(145deg, #fff5f5, #ffd6d6);
            border-bottom: 4px solid #ff8585;
            border-right: 4px solid #ff5c5c;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fff5f5 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - purple */
        .note.style-purple {
            background: #f9f0ff;
            background: linear-gradient(145deg, #fcf5ff, #f0d6ff);
            border-bottom: 4px solid #d3adf7;
            border-right: 4px solid #b37feb;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fcf5ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - orange */
        .note.style-orange {
            background: #fff7e6;
            background: linear-gradient(145deg, #fffbf0, #ffd6b3);
            border-bottom: 4px solid #ffc599;
            border-right: 4px solid #ffa94d;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fffbf0 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - teal */
        .note.style-teal {
            background: #e6fffb;
            background: linear-gradient(145deg, #f0fffb, #b3ffe6);
            border-bottom: 4px solid #85e6d9;
            border-right: 4px solid #5cdbd3;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0fffb inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - indigo */
        .note.style-indigo {
            background: #f0f5ff;
            background: linear-gradient(145deg, #f5f9ff, #d6e4ff);
            border-bottom: 4px solid #adc6ff;
            border-right: 4px solid #86a8ff;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f5f9ff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - lime */
        .note.style-lime {
            background: #fafff0;
            background: linear-gradient(145deg, #fdfef9, #e8f5c8);
            border-bottom: 4px solid #e6ff70;
            border-right: 4px solid #d3f975;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fdfef9 inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - cyan */
        .note.style-cyan {
            background: #e6ffff;
            background: linear-gradient(145deg, #f0ffff, #b3ffff);
            border-bottom: 4px solid #85ffff;
            border-right: 4px solid #5cdede;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #f0ffff inset;
        }
        
        /* ä¾¿ç­¾æ ·å¼ - amber */
        .note.style-amber {
            background: #fffbe6;
            background: linear-gradient(145deg, #fefcf0, #ffefb3);
            border-bottom: 4px solid #ffd591;
            border-right: 4px solid #ffc14d;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 #fefcf0 inset;
        }
        
        /* è‡ªå®šä¹‰é¢œè‰²ä¾¿ç­¾ */
        .note.custom-color {
            border-bottom: 4px solid rgba(0,0,0,0.2);
            border-right: 4px solid rgba(0,0,0,0.3);
            box-shadow: 6px 6px 15px rgba(0,0,0,0.4), 0 2px 0 rgba(255,255,255,0.3) inset;
        }
        .note:hover {
            filter: brightness(1.02);
            box-shadow: 10px 10px 22px rgba(0,0,0,0.5), 0 0 0 2px #fceeb6;
            cursor: grab;
        }
        .note:active {
            cursor: grabbing;
            z-index: 9999 !important;
            box-shadow: 14px 14px 25px rgba(0,0,0,0.6);
        }
        /* å°æŠ˜è§’ */
        .note::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 35px 35px 0;
            border-color: transparent #cfb07c transparent transparent;
            opacity: 0.6;
            pointer-events: none;
        }
        /* ä¾¿ç­¾å†…å®¹åŒºåŸŸ â€” æ¸²æŸ“ Markdown */
        .note-content {
            display: block;
            width: 100%;
            white-space: normal;
            word-break: break-word;
        }
        /* â”€â”€ è¿˜åŸè¢« * {margin:0;padding:0} æ¸…é›¶çš„ Markdown å…ƒç´ æ ·å¼ â”€â”€ */
        .note-content p {
            margin: 0 0 8px 0;
        }
        .note-content h1, .note-content h2, .note-content h3,
        .note-content h4, .note-content h5, .note-content h6 {
            font-weight: bold;
            margin: 6px 0 4px 0;
            line-height: 1.3;
        }
        .note-content h1 { font-size: 1.3em; }
        .note-content h2 { font-size: 1.15em; }
        .note-content h3 { font-size: 1.05em; }
        .note-content strong, .note-content b { font-weight: bold; }
        .note-content em, .note-content i { font-style: italic; }
        .note-content s, .note-content del { text-decoration: line-through; }
        .note-content ul, .note-content ol {
            margin: 4px 0 4px 18px;
            padding: 0;
        }
        .note-content ul { list-style: disc; }
        .note-content ol { list-style: decimal; }
        .note-content li { margin: 2px 0; }
        .note-content blockquote {
            border-left: 3px solid #c9a86c;
            margin: 6px 0 6px 4px;
            padding: 2px 0 2px 10px;
            color: #6b4f2a;
            font-style: italic;
        }
        .note-content code {
            background: rgba(0,0,0,0.08);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.88em;
        }
        .note-content pre {
            background: rgba(0,0,0,0.08);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 6px 0;
        }
        .note-content pre code {
            background: none;
            padding: 0;
        }
        .note-content hr {
            border: none;
            border-top: 1px dashed #c9a86c;
            margin: 8px 0;
        }
        .note-content a {
            color: #a55808;
            text-decoration: underline;
            cursor: pointer;
        }


        /* ä¾¿ç­¾ç½²å â€” ç»å¯¹å®šä½å›ºå®šäºå³ä¸‹è§’ */
        .note-author {
            position: absolute;
            bottom: 8px;
            right: 12px;
            left: 20px;         /* å·¦è¾¹ç•Œï¼Œé˜²æ­¢é•¿åå­—æº¢å‡º */
            font-size: 0.72rem;
            color: rgba(60,40,20,0.55);
            text-align: right;
            font-style: italic;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            pointer-events: none;
            border-top: 1px dashed rgba(0,0,0,0.12);
            padding-top: 4px;
            line-height: 1.3;
        }

        /* ç¼©æ”¾æ§åˆ¶æ¡ â€” å³ä¸‹è§’å›ºå®šï¼Œç§»åŠ¨ç«¯å‹å¥½ */
        .zoom-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(45, 36, 30, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 20px;
            border-radius: 40px;
            border: 2px solid #bb9d7b;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 20000;
            color: #f7e3c2;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            font-size: 1rem;
            touch-action: manipulation;
        }
        .zoom-control label {
            font-size: 1.3rem;
            font-weight: bold;
            line-height: 1;
        }
        .zoom-control input {
            width: 200px;
            height: 10px;
            background: #4f3e2e;
            border-radius: 20px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            touch-action: manipulation;
        }
        .zoom-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: #f7d9a0;
            border-radius: 50%;
            border: 2px solid #7b5b3e;
            box-shadow: 0 2px 8px black;
            cursor: grab;
            touch-action: manipulation;
        }
        .zoom-control input::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: #f7d9a0;
            border-radius: 50%;
            border: 2px solid #7b5b3e;
            cursor: grab;
            touch-action: manipulation;
        }
        .zoom-control span {
            min-width: 65px;
            font-size: 1.3rem;
            background: #2d1f14;
            padding: 5px 12px;
            border-radius: 40px;
            text-align: center;
            border: 1px solid #c8a87c;
        }

        /* ä¿¡æ¯å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300000;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 15px;
        }
        .modal-box {
            background: #fef7e9;
            max-width: 500px;
            width: 100%;
            padding: 25px 20px;
            border-radius: 40px 15px 40px 15px;
            box-shadow: 0 30px 40px rgba(0,0,0,0.6), 0 10px 0 #bc9f7e inset;
            text-align: left;
            border: 5px solid #dac29c;
            font-size: 1rem;
            color: #3f2e1f;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-box h2 {
            margin: 0 0 15px 0;
            font-weight: 400;
            color: #4a3322;
            font-size: 2rem;
            border-bottom: 2px dashed #b48c65;
            padding-bottom: 8px;
        }
        .modal-box ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        .modal-box li {
            margin: 8px 0;
        }
        .modal-box code {
            background: #2d241e;
            color: #fadfad;
            padding: 2px 8px;
            border-radius: 30px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .modal-close {
            background: #b48c65;
            border: none;
            border-bottom: 5px solid #7b5b3e;
            padding: 12px 30px;
            border-radius: 40px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.1s;
            margin-top: 15px;
            display: block;
            margin-left: auto;
            touch-action: manipulation;
        }
        .modal-close:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }
        .hidden {
            display: none;
        }

        /* ç§»åŠ¨ç«¯è°ƒæ•´æ»‘å—å®½åº¦ */
        @media (max-width: 600px) {
            .zoom-control {
                padding: 10px 15px;
                gap: 10px;
                bottom: 15px;
                right: 15px;
            }
            .zoom-control input {
                width: 130px;
            }
            .zoom-control span {
                min-width: 55px;
                font-size: 1.1rem;
            }
            .zoom-control label {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- æ»šåŠ¨å®¹å™¨ -->
    <div class="wall-wrapper" id="wallWrapper">
        <!-- å·¨å¢™ (10000x10000) -->
        <div class="wall" id="wall"></div>
    </div>

    <!-- ç¼©æ”¾æ»‘å— (å³ä¸‹è§’) -->
    <div class="zoom-control">
        <label>ğŸ”</label>
        <input type="range" id="zoomSlider" min="0.2" max="3" step="0.02" value="1">
        <span id="zoomPercent">100%</span>
    </div>

    <!-- å¼¹çª— (ä½¿ç”¨è¯´æ˜) -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal-box">
            <h2>ğŸ§± ä¾¿ç­¾æŠ•ç¨¿å¢™</h2>
            <ul>
                <li><strong>â• æ·»åŠ æŠ•ç¨¿</strong>ï¼šåœ¨ <code>notes-data.json</code> çš„ <code>notes</code> æ•°ç»„è¿½åŠ æ–°å¯¹è±¡ã€‚</li>
                <li><strong>ğŸ‘¤ ç½²åå­—æ®µ</strong>ï¼š<code>author</code>ï¼ˆæ˜µç§°ï¼‰ã€<code>avatar</code>ï¼ˆå¤´åƒé“¾æ¥ï¼‰ã€<code>from</code>ï¼ˆæ¥æºå¹³å°ï¼‰ã€‚</li>
                <li><strong>ğŸ¨ ä¾¿ç­¾é¢œè‰²</strong>ï¼š<code>style</code> å¡«é¢œè‰²åï¼ˆyellow/blueâ€¦ï¼‰ã€<code>#hex</code> æˆ–å›¾ç‰‡é“¾æ¥ã€‚</li>
                <li><strong>ğŸ“ æ”¯æŒ Markdown</strong>ï¼šç²—ä½“ã€æ–œä½“ã€åˆ—è¡¨ã€é“¾æ¥ã€ä»£ç å—å‡å¯ç”¨ã€‚</li>
                <li><strong>ğŸ” ç¼©æ”¾</strong>ï¼šå³ä¸‹è§’æ»‘å— / é¼ æ ‡æ»šè½® / ç§»åŠ¨ç«¯åŒæŒ‡ã€‚</li>
                <li><strong>ğŸ–±ï¸ æ‹–åŠ¨</strong>ï¼šå•æŒ‡/é¼ æ ‡æ‹–åŠ¨å¢™é¢ï¼Œä¾¿ç­¾ä¹Ÿå¯å•ç‹¬æ‹–æ‹½ã€‚</li>
            </ul>
            <button class="modal-close" id="closeModalBtn">å¼€å§‹æ¢ç´¢ ğŸš€</button>
        </div>
    </div>
    </div>

    <script>
        (function() {
            // å¢™é¢å¤§å°é…ç½® - å¯ä»¥è½»æ¾ä¿®æ”¹è¿™é‡Œæ¥æ”¹å˜å¢™é¢å°ºå¯¸
            const WALL_WIDTH = 10000;
            const WALL_HEIGHT = 10000;

            const wall = document.getElementById('wall');
            const wrapper = document.getElementById('wallWrapper');
            const slider = document.getElementById('zoomSlider');
            const zoomSpan = document.getElementById('zoomPercent');

            // è®¾ç½®å¢™é¢å¤§å°
            wall.style.width = WALL_WIDTH + 'px';
            wall.style.height = WALL_HEIGHT + 'px';

            let maxZIndex = 1000;
            let currentScale = 1.0; // å½“å‰ç¼©æ”¾å€¼

            // å·¥å…·å‡½æ•°ï¼šéšæœºèŒƒå›´
            const random = (min, max) => Math.random() * (max - min) + min;

            // â”€â”€ å¯è§å­—ç¬¦è®¡æ•°ï¼šå‰¥ç¦»æ‰€æœ‰ Markdown è¯­æ³•ç¬¦å·å’Œ URLï¼Œåªæ•°å®é™…å†…å®¹ â”€â”€
            const MAX_CHARS = 100;
            function countVisible(text) {
                if (!text) return 0;
                return text
                    .replace(/!?\[([^\]]*?)\]\([^)]*?\)/g, '$1') // é“¾æ¥/å›¾ç‰‡ï¼šåªä¿ç•™æ˜¾ç¤ºæ–‡å­—
                    .replace(/```[\s\S]*?```/g, m => m.slice(3, -3).trim()) // ä»£ç å—
                    .replace(/`([^`]*?)`/g, '$1')   // è¡Œå†…ä»£ç 
                    .replace(/^#{1,6}\s+/gm, '')     // æ ‡é¢˜ç¬¦å·
                    .replace(/[*_~]{1,3}/g, '')      // ç²—ä½“/æ–œä½“/åˆ é™¤çº¿ç¬¦å·
                    .replace(/^>\s*/gm, '')           // å¼•ç”¨ç¬¦å·
                    .replace(/^[-*+]\s+/gm, '')       // æ— åºåˆ—è¡¨ç¬¦å·
                    .replace(/^\d+\.\s+/gm, '')       // æœ‰åºåˆ—è¡¨ç¬¦å·
                    .replace(/^[-*_]{3,}\s*$/gm, '')  // æ°´å¹³çº¿
                    .replace(/\n/g, '')               // æ¢è¡Œä¸è®¡å­—æ•°
                    .length;
            }

            function truncateText(text) {
                if (!text) return '';
                if (countVisible(text) <= MAX_CHARS) return text;
                // é€æ­¥æ‰«æåŸæ–‡ï¼Œè·³è¿‡ä¸è®¡å­—æ•°çš„éƒ¨åˆ†ï¼Œè¾¾åˆ°ä¸Šé™æ—¶æˆªæ–­
                let visible = 0;
                let i = 0;
                while (i < text.length && visible < MAX_CHARS) {
                    const rest = text.slice(i);
                    let m;
                    // é“¾æ¥/å›¾ç‰‡ [æ˜¾ç¤ºæ–‡å­—](url) â†’ åªè®¡æ˜¾ç¤ºæ–‡å­—
                    if ((m = rest.match(/^!?\[([^\]]*?)\]\([^)]*?\)/))) {
                        visible += m[1].length; i += m[0].length; continue;
                    }
                    // ä»£ç å— ```...```
                    if ((m = rest.match(/^```[\s\S]*?```/))) {
                        visible += m[0].slice(3,-3).trim().replace(/\n/g,'').length;
                        i += m[0].length; continue;
                    }
                    // è¡Œå†…ä»£ç  `...`
                    if ((m = rest.match(/^`([^`]*?)`/))) {
                        visible += m[1].length; i += m[0].length; continue;
                    }
                    // æ ‡é¢˜ç¬¦å· # ## ...ï¼ˆè¡Œé¦–ï¼‰
                    if ((m = rest.match(/^#{1,6}\s+/))) { i += m[0].length; continue; }
                    // ç²—ä½“/æ–œä½“/åˆ é™¤çº¿ç¬¦å·
                    if ((m = rest.match(/^[*_~]{1,3}/))) { i += m[0].length; continue; }
                    // å¼•ç”¨ç¬¦å· > ï¼ˆè¡Œé¦–ï¼‰
                    if ((m = rest.match(/^>\s*/))) { i += m[0].length; continue; }
                    // åˆ—è¡¨ç¬¦å·ï¼ˆè¡Œé¦–ï¼‰
                    if ((m = rest.match(/^[-*+]\s+|^\d+\.\s+/))) { i += m[0].length; continue; }
                    // æ°´å¹³çº¿
                    if ((m = rest.match(/^[-*_]{3,}\s*\n/))) { i += m[0].length; continue; }
                    // æ¢è¡Œä¸è®¡
                    if (text[i] === '\n') { i++; continue; }
                    visible++;
                    i++;
                }
                return text.slice(0, i) + 'â€¦';
            }

            // Markdown æ¸²æŸ“ï¼ˆmarked æ˜¯ deferï¼Œå¯èƒ½ç¨åå°±ç»ªï¼‰
            function renderMarkdown(text) {
                if (typeof marked === 'undefined') return text; // é™çº§çº¯æ–‡æœ¬
                try { return marked.parse(text); } catch(e) { return text; }
            }

            // marked å°±ç»ªåé‡æ–°æ¸²æŸ“æ‰€æœ‰ä¾¿ç­¾å†…å®¹ï¼ˆä»…å½“ defer å¯¼è‡´é¦–æ¬¡æ¸²æŸ“æ˜¯çº¯æ–‡æœ¬æ—¶è§¦å‘ï¼‰
            function rewireMarkdown() {
                if (typeof marked === 'undefined') return;
                document.querySelectorAll('.note-content[data-raw]').forEach(el => {
                    try { el.innerHTML = marked.parse(el.dataset.raw); } catch(e) {}
                    delete el.dataset.raw;
                });
            }
            document.querySelector('script[src*="marked"]')
                ?.addEventListener('load', rewireMarkdown);

            // åˆ›å»ºä¾¿ç­¾ï¼ˆæ”¯æŒ styleï¼šé¢œè‰²å / #hex / å›¾ç‰‡é“¾æ¥ï¼Œä»¥åŠå¯é€‰ author ç½²åï¼‰
            function createNote(mdText, left, top, rotate = null, style = 'yellow', author = '') {
                const note = document.createElement('div');
                note.className = 'note';

                // â”€â”€ èƒŒæ™¯æ ·å¼ â”€â”€
                if (typeof style === 'string') {
                    if (style.startsWith('http') || style.startsWith('//')) {
                        note.classList.add('has-image-bg');
                        const img = new Image();
                        img.onload = () => {
                            note.style.setProperty('background-image', `url("${style}")`, 'important');
                        };
                        img.onerror = () => note.classList.add('img-error');
                        // å…ˆä¸è®¾ crossOriginï¼Œå¤§å¤šæ•°å›¾åºŠä¸éœ€è¦ï¼Œé¿å… CORS preflight æ‹–æ…¢
                        img.src = style;
                    } else if (style.startsWith('#')) {
                        note.classList.add('custom-color');
                        note.style.background = `linear-gradient(145deg, ${lightenColor(style, 5)}, ${darkenColor(style, 5)})`;
                    } else {
                        note.classList.add(`style-${style}`);
                    }
                } else {
                    note.classList.add('style-yellow');
                }

                // â”€â”€ æ—‹è½¬ & ä½ç½® â”€â”€
                const rot = (rotate !== null) ? rotate : random(-5, 6);
                note.style.transform = `rotate(${rot}deg)`;
                const noteLeft = left !== null ? left : random(200, WALL_WIDTH - 200);
                const noteTop  = top  !== null ? top  : random(200, WALL_HEIGHT - 200);
                note.style.left = noteLeft + 'px';
                note.style.top  = noteTop  + 'px';
                note.style.zIndex = Math.floor(random(10, 500));

                // â”€â”€ æ­£æ–‡å†…å®¹ â”€â”€
                const contentSpan = document.createElement('span');
                contentSpan.className = 'note-content';
                const truncated = truncateText(mdText);
                const html = renderMarkdown(truncated);
                contentSpan.innerHTML = html;
                // è‹¥ marked å°šæœªå°±ç»ªï¼ˆdeferï¼‰ï¼Œä¿å­˜åŸæ–‡ä¾› rewireMarkdown è¡¥æ¸²æŸ“
                if (html === truncated && truncated.trim()) {
                    contentSpan.dataset.raw = truncated;
                }
                note.appendChild(contentSpan);

                // â”€â”€ ç½²åï¼ˆæœ‰ author æ—¶æ˜¾ç¤ºï¼‰â”€â”€
                if (author && author.trim()) {
                    const authorEl = document.createElement('span');
                    authorEl.className = 'note-author';
                    authorEl.textContent = 'â€” ' + author.trim();
                    note.appendChild(authorEl);
                }

                makeDraggable(note);
                return note;
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´é¢œè‰²äº®åº¦
            function lightenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
            }
            
            function darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R>255?255:R<0?0:R)*0x10000 + (G>255?255:G<0?0:G)*0x100 + (B>255?255:B<0?0:B)).toString(16).slice(1);
            }

            // â”€â”€ ä¾¿ç­¾æ‹–æ‹½ï¼šäº‹ä»¶å§”æ‰˜åˆ° wallï¼Œé¿å… N å¼ ä¾¿ç­¾ Ã— 2 ä¸ªç›‘å¬å™¨ â”€â”€
            // æ‹–æ‹½çŠ¶æ€ï¼ˆå…¨å±€å•ä¾‹ï¼ŒåŒæ—¶åªèƒ½æ‹–ä¸€å¼ ï¼‰
            let dragNote = null, dragStartX = 0, dragStartY = 0;
            let dragInitLeft = 0, dragInitTop = 0;
            let dragHasMoved = false;
            let dragVX = 0, dragVY = 0, dragLastX = 0, dragLastY = 0, dragLastT = 0;
            let dragRafId = null;
            // é¢„å­˜ä¾¿ç­¾å°ºå¯¸ï¼Œé¿å…æ‹–åŠ¨ä¸­åå¤è§¦å‘ layout
            const NOTE_W = 240, NOTE_H = 200;

            function noteDragStart(note, clientX, clientY) {
                dragNote = note;
                dragStartX = clientX; dragStartY = clientY;
                dragInitLeft  = parseFloat(note.style.left)  || 0;
                dragInitTop   = parseFloat(note.style.top)   || 0;
                dragLastX = clientX; dragLastY = clientY;
                dragLastT = Date.now();
                dragVX = 0; dragVY = 0;
                dragHasMoved = false;
                maxZIndex++;
                note.style.zIndex = maxZIndex;
                note.style.transition = 'none';
            }

            function noteDragMove(clientX, clientY) {
                if (!dragNote) return;
                const now = Date.now(), dt = now - dragLastT;
                if (dt > 0) {
                    dragVX = (clientX - dragLastX) / dt * 16;
                    dragVY = (clientY - dragLastY) / dt * 16;
                }
                dragLastX = clientX; dragLastY = clientY; dragLastT = now;

                const dx = clientX - dragStartX, dy = clientY - dragStartY;
                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) dragHasMoved = true;

                let newLeft = Math.min(WALL_WIDTH - 30,  Math.max(-NOTE_W + 30, dragInitLeft + dx));
                let newTop  = Math.min(WALL_HEIGHT - 30, Math.max(-NOTE_H + 30, dragInitTop  + dy));

                // rAF èŠ‚æµå†™ DOM
                if (dragRafId) cancelAnimationFrame(dragRafId);
                dragRafId = requestAnimationFrame(() => {
                    if (dragNote) {
                        dragNote.style.left = newLeft + 'px';
                        dragNote.style.top  = newTop  + 'px';
                    }
                });
            }

            function noteDragEnd() {
                if (!dragNote) return;
                cancelAnimationFrame(dragRafId);
                if (dragHasMoved) {
                    const note = dragNote;
                    const vx = dragVX, vy = dragVY;
                    let newLeft = Math.min(WALL_WIDTH-30, Math.max(-NOTE_W+30,
                        parseFloat(note.style.left) + vx * 0.5));
                    let newTop  = Math.min(WALL_HEIGHT-30, Math.max(-NOTE_H+30,
                        parseFloat(note.style.top)  + vy * 0.5));
                    note.style.transition = 'left 0.25s ease-out, top 0.25s ease-out';
                    note.style.left = newLeft + 'px';
                    note.style.top  = newTop  + 'px';
                    setTimeout(() => { if (note) note.style.transition = 'none'; }, 260);
                }
                dragNote = null;
                dragRafId = null;
            }

            // wall å±‚ç»Ÿä¸€å§”æ‰˜ mousedown / touchstart
            function initNoteDrag() {
                wall.addEventListener('mousedown', (e) => {
                    const note = e.target.closest('.note');
                    if (!note || e.button !== 0) return;
                    if (e.target.closest('a')) return; // è¶…é“¾æ¥ä¸æ‹–
                    e.preventDefault(); e.stopPropagation();
                    noteDragStart(note, e.clientX, e.clientY);
                    document.addEventListener('mousemove', onDocMouseMove);
                    document.addEventListener('mouseup',  onDocMouseUp,  { once: true });
                });
                wall.addEventListener('touchstart', (e) => {
                    if (e.touches.length !== 1) return;
                    const note = e.target.closest('.note');
                    if (!note) return;
                    if (e.target.closest('a')) return;
                    e.preventDefault(); e.stopPropagation();
                    noteDragStart(note, e.touches[0].clientX, e.touches[0].clientY);
                    document.addEventListener('touchmove', onDocTouchMove, { passive: false });
                    document.addEventListener('touchend',  onDocTouchEnd,  { once: true });
                    document.addEventListener('touchcancel', onDocTouchEnd, { once: true });
                }, { passive: false });
            }
            function onDocMouseMove(e) { noteDragMove(e.clientX, e.clientY); }
            function onDocMouseUp()    { noteDragEnd(); document.removeEventListener('mousemove', onDocMouseMove); }
            function onDocTouchMove(e) { e.preventDefault(); if (e.touches.length===1) noteDragMove(e.touches[0].clientX, e.touches[0].clientY); }
            function onDocTouchEnd()   { noteDragEnd(); document.removeEventListener('touchmove', onDocTouchMove); }
            // makeDraggable ä¿ç•™ä¸ºç©ºæ“ä½œï¼ˆcreateNote ä»ä¼šè°ƒç”¨ï¼‰
            function makeDraggable(_el) { /* å·²æ”¹ä¸º wall å±‚äº‹ä»¶å§”æ‰˜ï¼Œæ— éœ€é€å…ƒç´ ç»‘å®š */ }

            // åˆå§‹åŒ–ä¾¿ç­¾ï¼ˆDocumentFragment æ‰¹é‡æ’å…¥ï¼Œåªè§¦å‘ä¸€æ¬¡ reflowï¼‰
            function initDefaultNotes(data = null) {
                if (!data || !data.notes) return;
                const frag = document.createDocumentFragment();
                data.notes.forEach((item) => {
                    frag.appendChild(createNote(
                        item.text,
                        null, null, null,
                        item.style  || 'yellow',
                        item.author || ''
                    ));
                });
                wall.appendChild(frag);
            }

            // è®¾å¤‡æ£€æµ‹
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            const mobileDevice = isMobileDevice();
            
            // å­˜å‚¨å…‰æ ‡ä½ç½®
            let cursorPos = { x: 0, y: 0 };
            
            // æ›´æ–°å…‰æ ‡ä½ç½®ï¼ˆthrottleï¼šæ¯å¸§æœ€å¤šæ›´æ–°ä¸€æ¬¡ï¼‰
            let cursorRafPending = false;
            wrapper.addEventListener('mousemove', (e) => {
                if (cursorRafPending) return;
                cursorRafPending = true;
                requestAnimationFrame(() => {
                    cursorPos.x = e.clientX;
                    cursorPos.y = e.clientY;
                    cursorRafPending = false;
                });
            }, { passive: true });

            // ========== ç¼©æ”¾é€»è¾‘ (æ”¯æŒè·Ÿéšå…‰æ ‡ï¼Œä¸å‡ºç•Œ) ==========
            // æ³¨æ„ï¼šwrapper.scrollLeft/scrollTop å·¥ä½œåœ¨"ç¼©æ”¾ååƒç´ "åæ ‡ç³»ä¸­ã€‚
            // å¢™ç»è¿‡ scale(s) åï¼Œå…¶å®é™…å ç”¨å®½åº¦ = WALL_WIDTH * sï¼Œ
            // æ‰€ä»¥ maxScrollLeft = WALL_WIDTH * s - vwï¼Œå•ä½éƒ½æ˜¯å±å¹•åƒç´ ã€‚
            function updateZoom(newScale, useCursor = false) {
                const vw = wrapper.clientWidth;
                const vh = wrapper.clientHeight;
                if (vw === 0 || vh === 0) return;

                const oldScale = currentScale;

                // ç¼©æ”¾åå¢™çš„å®é™…å±å¹•åƒç´ å°ºå¯¸
                const scaledW = WALL_WIDTH * newScale;
                const scaledH = WALL_HEIGHT * newScale;

                // ç¡®å®š"é”šç‚¹"ï¼šç¼©æ”¾å‰åè¯¥ç‚¹åœ¨å±å¹•ä¸Šä¿æŒä¸åŠ¨
                // focusX/Y æ˜¯è§†å£å†…çš„å±å¹•åæ ‡ï¼ˆåƒç´ ï¼‰
                let focusX, focusY;
                if (useCursor && !mobileDevice) {
                    focusX = cursorPos.x;
                    focusY = cursorPos.y;
                } else {
                    // ä»¥è§†å£ä¸­å¿ƒä¸ºé”šç‚¹
                    focusX = vw / 2;
                    focusY = vh / 2;
                }

                // é”šç‚¹åœ¨ç¼©æ”¾å‰å¢™é¢ä¸Šçš„ç»å¯¹ä½ç½®ï¼ˆå¢™åæ ‡ç³»ï¼Œå•ä½ï¼šå¢™åƒç´ ï¼‰
                // å½“å‰ scrollLeft/Top æ˜¯å±å¹•åƒç´ ï¼Œé™¤ä»¥ oldScale å¾—åˆ°å¢™åæ ‡
                const anchorWallX = (wrapper.scrollLeft + focusX) / oldScale;
                const anchorWallY = (wrapper.scrollTop + focusY) / oldScale;

                // ç¼©æ”¾åï¼Œä¸ºäº†è®©é”šç‚¹ä»ä½äºå±å¹•ä¸ŠåŒä¸€ä½ç½®ï¼Œæ–°çš„ scrollLeft/Topï¼š
                let newScrollLeft = anchorWallX * newScale - focusX;
                let newScrollTop  = anchorWallY * newScale - focusY;

                // é™åˆ¶æ»šåŠ¨èŒƒå›´ï¼Œç¡®ä¿ä¸ä¼šè¶…å‡ºå¢™é¢è¾¹ç•Œ
                // æœ€å¤§æ»šåŠ¨ = ç¼©æ”¾åå¢™å°ºå¯¸ - è§†å£å°ºå¯¸ï¼›è‹¥å¢™æ¯”è§†å£å°åˆ™å±…ä¸­
                const maxScrollLeft = Math.max(0, scaledW - vw);
                const maxScrollTop  = Math.max(0, scaledH - vh);

                if (scaledW <= vw) {
                    // å¢™æ¯”è§†å£çª„æ—¶æ°´å¹³å±…ä¸­
                    newScrollLeft = -(vw - scaledW) / 2;
                } else {
                    newScrollLeft = Math.max(0, Math.min(maxScrollLeft, newScrollLeft));
                }

                if (scaledH <= vh) {
                    // å¢™æ¯”è§†å£çŸ®æ—¶å‚ç›´å±…ä¸­
                    newScrollTop = -(vh - scaledH) / 2;
                } else {
                    newScrollTop = Math.max(0, Math.min(maxScrollTop, newScrollTop));
                }

                // åº”ç”¨ç¼©æ”¾ï¼Œç„¶åè®¾ç½®æ»šåŠ¨ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰
                wall.style.transform = `scale(${newScale})`;
                wrapper.scrollLeft = newScrollLeft;
                wrapper.scrollTop  = newScrollTop;

                // æ›´æ–°å½“å‰ç¼©æ”¾å€¼
                currentScale = newScale;
                zoomSpan.innerText = Math.round(newScale * 100) + '%';
            }

            // æ»‘å—äº‹ä»¶
            slider.addEventListener('input', (e) => {
                const newScale = parseFloat(e.target.value);
                updateZoom(newScale, !mobileDevice); // æ ¹æ®è®¾å¤‡ç±»å‹å†³å®šæ˜¯å¦ä½¿ç”¨å…‰æ ‡è·Ÿéšç¼©æ”¾
            });

            // æ»šåŠ¨åˆ°å¢™é¢ä¸­å¿ƒ
            function scrollToCenter() {
                const vw = wrapper.clientWidth, vh = wrapper.clientHeight;
                const scaledW = WALL_WIDTH * currentScale, scaledH = WALL_HEIGHT * currentScale;
                slider.value = currentScale;
                zoomSpan.innerText = Math.round(currentScale * 100) + '%';
                wall.style.transform = `scale(${currentScale})`;
                wrapper.scrollLeft = Math.max(0, Math.min(scaledW - vw, scaledW / 2 - vw / 2));
                wrapper.scrollTop  = Math.max(0, Math.min(scaledH - vh, scaledH / 2 - vh / 2));
            }

            // åˆå§‹åŒ–ï¼šåŠ è½½ä¾¿ç­¾ â†’ æ¸²æŸ“ â†’ æ»šåŠ¨å®šä½
            window.addEventListener('DOMContentLoaded', () => {
                // æ‰‹åŠ¿å’Œå§”æ‰˜ç«‹å³ç»‘å®šï¼Œä¸ç­‰ fetch
                makeWallDraggable();
                initNoteDrag();
                // å…ˆå®šä½ï¼Œé¿å…åŠ è½½æ•°æ®æ—¶é¡µé¢ç©ºç™½
                scrollToCenter();
            });

            window.addEventListener('load', async () => {
                // marked åº“å¯èƒ½å›  defer ç¨æ™šå°±ç»ªï¼Œæ­¤å¤„æ— éœ€ç­‰å¾…ï¼ˆrenderMarkdown æœ‰åˆ¤æ–­ï¼‰
                try {
                    const response = await fetch(`notes-data.json?t=${Date.now()}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    initDefaultNotes(data);
                } catch (error) {
                    console.warn('æ— æ³•åŠ è½½ä¾¿ç­¾æ•°æ®:', error.message);
                }
            });

            // â”€â”€ å¢™é¢æ‰‹åŠ¿ç®¡ç†å™¨ï¼šç»Ÿä¸€å¤„ç†å•æŒ‡æ‹–åŠ¨ + åŒæŒ‡ç¼©æ”¾ â”€â”€
            function makeWallDraggable() {

                // â”€â”€ é¼ æ ‡æ‹–åŠ¨ï¼ˆæ¡Œé¢ç«¯ï¼‰â”€â”€
                let mouseDown = false;
                let mouseStartX, mouseStartY, mouseInitSL, mouseInitST;

                function onMouseDown(e) {
                    if (e.target === wall || e.target === wrapper) {
                        if (e.button !== 0) return;
                        e.preventDefault();
                        mouseDown = true;
                        mouseStartX = e.clientX;
                        mouseStartY = e.clientY;
                        mouseInitSL = wrapper.scrollLeft;
                        mouseInitST = wrapper.scrollTop;
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    }
                }
                function onMouseMove(e) {
                    if (!mouseDown) return;
                    wrapper.scrollLeft = mouseInitSL - (e.clientX - mouseStartX);
                    wrapper.scrollTop  = mouseInitST  - (e.clientY - mouseStartY);
                }
                function onMouseUp() {
                    mouseDown = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                wall.addEventListener('mousedown', onMouseDown);
                wrapper.addEventListener('mousedown', onMouseDown);

                // â”€â”€ è§¦æ‘¸æ‰‹åŠ¿ï¼ˆç§»åŠ¨ç«¯ï¼‰ï¼šå•æŒ‡æ‹–åŠ¨ + åŒæŒ‡ pinch ç¼©æ”¾ â”€â”€
                // çŠ¶æ€æœºï¼šidle â†’ drag(1finger) / pinch(2finger)
                let touchState = 'idle'; // 'idle' | 'drag' | 'pinch'
                let dragStartX, dragStartY, dragInitSL, dragInitST;
                let pinchInitDist, pinchInitScale, pinchInitMidX, pinchInitMidY;
                let pinchInitSL, pinchInitST;

                function getTouchMidpoint(touches) {
                    return {
                        x: (touches[0].clientX + touches[1].clientX) / 2,
                        y: (touches[0].clientY + touches[1].clientY) / 2,
                    };
                }
                function getTouchDist(touches) {
                    const dx = touches[1].clientX - touches[0].clientX;
                    const dy = touches[1].clientY - touches[0].clientY;
                    return Math.sqrt(dx * dx + dy * dy);
                }

                function onTouchStart(e) {
                    // å¦‚æœè§¦æ‘¸èµ·ç‚¹åœ¨ zoom-control å†…ï¼Œå¿½ç•¥ï¼ˆè®©æ»‘å—è‡ªå·±å¤„ç†ï¼‰
                    if (e.target.closest && e.target.closest('.zoom-control')) return;

                    if (e.touches.length === 1) {
                        // åªå“åº”å¢™é¢/å®¹å™¨åŒºåŸŸçš„å•æŒ‡
                        if (e.target === wall || e.target === wrapper) {
                            e.preventDefault();
                            touchState = 'drag';
                            dragStartX = e.touches[0].clientX;
                            dragStartY = e.touches[0].clientY;
                            dragInitSL = wrapper.scrollLeft;
                            dragInitST = wrapper.scrollTop;
                        }
                    } else if (e.touches.length === 2) {
                        // åŒæŒ‡ï¼šæ— è®ºä»å“ªé‡Œè½ä¸‹éƒ½è¿›å…¥ pinch æ¨¡å¼ï¼Œè¦†ç›–ä¹‹å‰çš„æ‹–åŠ¨
                        e.preventDefault();
                        touchState = 'pinch';
                        pinchInitDist  = getTouchDist(e.touches);
                        pinchInitScale = currentScale;
                        const mid = getTouchMidpoint(e.touches);
                        pinchInitMidX = mid.x;
                        pinchInitMidY = mid.y;
                        pinchInitSL = wrapper.scrollLeft;
                        pinchInitST = wrapper.scrollTop;
                    }
                }

                function onTouchMove(e) {
                    if (touchState === 'idle') return;
                    e.preventDefault();

                    if (touchState === 'drag' && e.touches.length === 1) {
                        const dx = e.touches[0].clientX - dragStartX;
                        const dy = e.touches[0].clientY - dragStartY;
                        wrapper.scrollLeft = dragInitSL - dx;
                        wrapper.scrollTop  = dragInitST  - dy;

                    } else if (e.touches.length === 2) {
                        // å¦‚æœä¸­é€”å˜ä¸ºåŒæŒ‡ï¼Œå‡çº§ä¸º pinch
                        if (touchState !== 'pinch') {
                            touchState = 'pinch';
                            pinchInitDist  = getTouchDist(e.touches);
                            pinchInitScale = currentScale;
                            const mid = getTouchMidpoint(e.touches);
                            pinchInitMidX = mid.x;
                            pinchInitMidY = mid.y;
                            pinchInitSL = wrapper.scrollLeft;
                            pinchInitST = wrapper.scrollTop;
                            return;
                        }

                        const dist = getTouchDist(e.touches);
                        let newScale = pinchInitScale * (dist / pinchInitDist);
                        newScale = Math.max(0.2, Math.min(3, newScale));

                        // ä»¥åŒæŒ‡ä¸­ç‚¹ä¸ºç¼©æ”¾é”šç‚¹
                        const mid = getTouchMidpoint(e.touches);
                        const oldScale = currentScale;

                        // é”šç‚¹åœ¨å¢™åæ ‡ç³»çš„ä½ç½®ï¼ˆç”¨ç¼©æ”¾å‰ scroll + åˆå§‹ä¸­ç‚¹è®¡ç®—ï¼‰
                        const anchorWallX = (pinchInitSL + pinchInitMidX) / pinchInitScale;
                        const anchorWallY = (pinchInitST  + pinchInitMidY) / pinchInitScale;

                        // æ–° scrollï¼šè®©åŒä¸€å¢™åæ ‡ç‚¹å¯¹é½åˆ°å½“å‰ä¸­ç‚¹å±å¹•ä½ç½®
                        let newSL = anchorWallX * newScale - mid.x;
                        let newST = anchorWallY * newScale - mid.y;

                        const scaledW = WALL_WIDTH  * newScale;
                        const scaledH = WALL_HEIGHT * newScale;
                        const vw = wrapper.clientWidth;
                        const vh = wrapper.clientHeight;
                        newSL = Math.max(0, Math.min(Math.max(0, scaledW - vw), newSL));
                        newST = Math.max(0, Math.min(Math.max(0, scaledH - vh), newST));

                        wall.style.transform = `scale(${newScale})`;
                        wrapper.scrollLeft = newSL;
                        wrapper.scrollTop  = newST;
                        currentScale = newScale;
                        slider.value = newScale;
                        zoomSpan.innerText = Math.round(newScale * 100) + '%';
                    }
                }

                function onTouchEnd(e) {
                    if (e.touches.length === 0) {
                        touchState = 'idle';
                    } else if (e.touches.length === 1 && touchState === 'pinch') {
                        // ä»åŒæŒ‡å˜å›å•æŒ‡ï¼šé‡ç½®æ‹–åŠ¨èµ·ç‚¹ï¼Œå¹³æ»‘åˆ‡æ¢
                        touchState = 'drag';
                        dragStartX = e.touches[0].clientX;
                        dragStartY = e.touches[0].clientY;
                        dragInitSL = wrapper.scrollLeft;
                        dragInitST = wrapper.scrollTop;
                    }
                }

                wrapper.addEventListener('touchstart', onTouchStart, { passive: false });
                wall.addEventListener('touchstart',    onTouchStart, { passive: false });
                // move/end æŒ‚åœ¨ documentï¼Œé¿å…æ‰‹æŒ‡åˆ’å‡º wrapper æ—¶ä¸¢å¤±äº‹ä»¶
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend',  onTouchEnd,  { passive: true });
                document.addEventListener('touchcancel', onTouchEnd, { passive: true });
            }

            // zoom-control é˜»æ­¢è§¦æ‘¸äº‹ä»¶å†’æ³¡åˆ° wrapperï¼ˆé˜²æ­¢æ»‘å—æ“ä½œè§¦å‘å¢™é¢æ‹–åŠ¨ï¼‰
            document.querySelector('.zoom-control').addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, { passive: true });
            document.querySelector('.zoom-control').addEventListener('touchmove', (e) => {
                e.stopPropagation();
            }, { passive: true });

            // å¼¹çª—æ§åˆ¶
            const modal = document.getElementById('infoModal');
            const closeBtn = document.getElementById('closeModalBtn');
            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // é¼ æ ‡æ»šè½®ç¼©æ”¾ï¼ˆpassive:false å…è®¸ preventDefaultï¼ŒrAF èŠ‚æµé¿å…è¿ç»­å¸§å †ç§¯ï¼‰
            let wheelRafId = null;
            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                cursorPos.x = e.clientX;
                cursorPos.y = e.clientY;
                const delta = e.deltaY > 0 ? -0.05 : 0.05;
                let newScale = Math.max(0.2, Math.min(3, currentScale + delta));
                slider.value = newScale;
                if (wheelRafId) return; // ä¸Šä¸€å¸§è¿˜æ²¡å¤„ç†å®Œï¼Œè·³è¿‡
                wheelRafId = requestAnimationFrame(() => {
                    updateZoom(newScale, !mobileDevice);
                    wheelRafId = null;
                });
            }, { passive: false });

            // åŒæŒ‡ç¼©æ”¾å·²æ•´åˆè‡³ makeWallDraggable() çš„ç»Ÿä¸€æ‰‹åŠ¿ç®¡ç†å™¨

            // çª—å£resizeæ—¶ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æ»šåŠ¨è¾¹ç•Œ (ä¿æŒä¸­å¿ƒç‚¹ï¼Ÿä¸ºäº†ç®€åŒ–ï¼Œä¸åšé¢å¤–å¤„ç†ï¼Œä½†å¯ä¿æŒç¼©æ”¾ä¸å˜)
            // å¯é€‰ï¼šresize æ—¶é‡æ–°é™åˆ¶æ»šåŠ¨è¾¹ç•Œï¼Œä½†æ— éœ€æ›´æ”¹ç¼©æ”¾ã€‚
            window.addEventListener('resize', () => {
                // ä¿è¯æ»šåŠ¨ä½ç½®ä¸è¶Šç•Œï¼ˆåæ ‡ç³»ï¼šç¼©æ”¾åå±å¹•åƒç´ ï¼‰
                const vw = wrapper.clientWidth;
                const vh = wrapper.clientHeight;
                const scaledW = WALL_WIDTH * currentScale;
                const scaledH = WALL_HEIGHT * currentScale;
                const maxLeft = Math.max(0, scaledW - vw);
                const maxTop  = Math.max(0, scaledH - vh);
                wrapper.scrollLeft = Math.max(0, Math.min(maxLeft, wrapper.scrollLeft));
                wrapper.scrollTop  = Math.max(0, Math.min(maxTop,  wrapper.scrollTop));
            });
        })();
    </script>
</body>
</html>